<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Secret</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #007bff, #ffa500);
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding-top: 40px;
    }

    h2 {
      margin-bottom: 20px;
    }

    textarea, input[type="text"] {
      width: 80%;
      max-width: 600px;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      margin-bottom: 15px;
      color: black;
    }

    textarea {
      height: 120px;
      resize: none;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      color: white;
      background-color: #ff7f00;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    button:hover {
      background-color: #e67300;
    }

    .filename {
      font-style: italic;
      margin-bottom: 10px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h2>Decrypt Your Secret</h2>
  <textarea id="privateKey" placeholder="Paste your PRIVATE key here..."></textarea><br>
  <button onclick="decrypt()">Decrypt</button>

  <div id="textSecret" class="hidden">
    <h2>Your Decrypted Secret:</h2>
    <textarea id="decryptedSecret" readonly></textarea><br>
    <button onclick="copySecret()">Copy to Clipboard</button>
  </div>

  <div id="fileSecret" class="hidden">
    <h2>Your File is Ready</h2>
    <div class="filename">Filename: <strong id="fileNameBox"></strong></div>
    <button onclick="downloadDecryptedFile()">Download File</button>
  </div>

  <!-- Encrypted data embedded by server -->
  <script>
    const encrypted = "{{ encrypted }}";
    const isFile = {{ 'true' if is_file else 'false' }};
    const filename = "{{ filename if is_file else '' }}";
    const mimetype = "{{ mimetype if is_file else '' }}";
  </script>

  <!-- Decryption Script -->
  <script>
    async function importPrivateKey(pemKey) {
      const binaryDerString = window.atob(pemKey.replace(/-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAycbP9IKtlDPtium/AeERWCUpcgDQVJYrL3KzUSr5f2m5Wcjr
Aj98BCg7Mhy6OyXrw+u/ON7UUdEWyVNEIi2L7snV0po5/qLRfIi2qPqjsYz2l/9c
6BLZ9LfwLst0aXuL4eHZVkM0cBOEFUjF+ivMCI2448rRswtkP2eRCGqT+55Pj7kU
+Q8NX92U091sL76sVRe857ZFDONrT6EpGHUYVsL+qh2ovERkLh0FJQXjd62OkszG
vxrJvqnrLgPh6LqZFJ2MIDT9N0y2pixSUh6P2bvl9n1yJwkE6i9V2MgRsXPfcHGH
VhXjkukHuO6ijjnq23b9mxCUv8hjj9LTscEa+QIDAQABAoIBABj6nkroPzcozeA+
ZfwvEdfGKKEpiEuNwu80Srj30ibw/oD8IQUduStwlDzKFqSfjKuBTKJsiin4xv00
bCuzqhjtGVCMRuAG5a/TjZKnY0q7Jy8+Qzui/c16/zu5Hy0Mc47f8pO9wnOaJDtY
T33+xwWguddQB/Fw2GpgVrGNNCBYIA+5BtgI62D/7bIp2T3t408wDV9EJlomiuXB
sVZizSa3ppK8L6uxzwmd90Uxjzh1M9uGUlohCpVM85jc021L2VotrryFqOlKZytQ
wZLn/DsC68aABDZNI7zbCwi5u5ujT3hJP5D0w+2hY/Tdy0qXPWuXLVvsFw2SUhip
dqUZTgsCgYEA6NVJwO9ss57RzGppwM29khmOjK29PqI/gheY3OR9XvNGFcAfW4Y4
gZ2nXnuCkqfGUSD+Q+QZZY52E+2v6hGXvzkxja4JdjKYV3OprGAMWJGatiT1u7AI
IAH1woYNGheyvTBETn8sQaXOHk2WRqPBQMQu6W1dQx6zbMexE/Bs/ksCgYEA3dp0
K25wlSwSUZ1jQmEZ1phNf10MmFkUKAWw5B7tcnCNWGmWj7rfRXdeenoNFjzMHscb
N3myhYZCO4Ysp1aBFie/wCGvacpuTDiucrvxu380/lGMwojcvjOToLhAQ/xMjjFS
4s6qqmV45D82+GY6oS1YUe0FuNSydseZSnaK8UsCgYEAqFg2yGoUhVbKyGsUZZQc
gfs6h1rDXvr+wjf/jY8jWri4rtdHlOxaBNWRgw34XcMy78vULBBLkJNNqqELtUjd
GCTpQFBahPyWC30UbA7SPmOgohvdFMR1S3c/U1OLO5dw47t3V+45eInCm0Rr6E1U
WFjAtoQdj38uKfPEg+8tTzsCgYAC/Fen5fqZ51fvxUB6ujfQzYfteOEcg8Zjq3/v
8gKcEau1TuZ51LgAhVS+LTpT3Ema+G8DVh3y8hWeG3YqYl2mYK6R9WIY+GJ3oCOo
46KjNVkPOyW70H+4B5WrCg/DWnflSgClkMZ3OJph5//jY+zSEnwnzhrPm/0y4AjO
Gb5Q9QKBgHG+FdHphRuCdLJh+Q5FMkiVysZ0pUVrJJoTZw4luqHWE7ZyMgHkokGO
JH0e9ZnCHv0Fma3M8ZZ3HdxHhFMBKpAn0ngQhXhX79hHKR7XA1hx4qJluC1gGElB
5F8gpJkajeAvFZv7XlKXVZM+SCUPVit8u5WCr3R9BLbMyKetCy0a
-----END RSA PRIVATE KEY-----/g, '').trim());
      const binaryDer = str2ab(binaryDerString);
      return await window.crypto.subtle.importKey(
        "pkcs8",
        binaryDer,
        {
          name: "RSA-OAEP",
          hash: "SHA-256",
        },
        false,
        ["decrypt"]
      );
    }

    function str2ab(str) {
      const buf = new ArrayBuffer(str.length);
      const bufView = new Uint8Array(buf);
      for (let i = 0, strLen = str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return buf;
    }

    async function decryptData(encryptedB64, privateKey) {
      const encryptedBytes = Uint8Array.from(atob(encryptedB64), c => c.charCodeAt(0));
      const decrypted = await window.crypto.subtle.decrypt(
        { name: "RSA-OAEP" },
        privateKey,
        encryptedBytes
      );
      return new Uint8Array(decrypted);
    }

    async function decrypt() {
      const privateKeyText = document.getElementById("privateKey").value.trim();
      if (!privateKeyText) {
        alert("Please paste your private key.");
        }

      try {
        const privateKey = await importPrivateKey(privateKeyText);
        const decryptedBytes = await decryptData(encrypted, privateKey);

        if (isFile) {
          window.decryptedFile = decryptedBytes;
          document.getElementById("fileNameBox").innerText = filename;
          document.getElementById("fileSecret").classList.remove("hidden");
        } else {
          const decoded = new TextDecoder().decode(decryptedBytes);
          document.getElementById("decryptedSecret").value = decoded;
          document.getElementById("textSecret").classList.remove("hidden");
        }
      } catch (e) {
        console.error(e);
        alert("Failed to decrypt. Make sure the private key is correct.");
      }
    }

    function copySecret() {
      const textArea = document.getElementById("decryptedSecret");
      textArea.select();
      document.execCommand("copy");
      alert("Secret copied to clipboard!");
    }

    function downloadDecryptedFile() {
      const blob = new Blob([window.decryptedFile], { type: mimetype || "application/octet-stream" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename || "secret-file";
      link.click();
    }
  </script>

</body>
</html>

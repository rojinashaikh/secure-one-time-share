<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Secret</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #007bff, #ffa500);
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      text-align: center;
      padding-top: 40px;
    }

    h2 {
      margin-bottom: 20px;
    }

    textarea, input[type="text"] {
      width: 80%;
      max-width: 600px;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      margin-bottom: 15px;
      color: black;
    }

    textarea {
      height: 120px;
      resize: none;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      color: white;
      background-color: #ff7f00;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    button:hover {
      background-color: #e67300;
    }

    .filename {
      font-style: italic;
      margin-bottom: 10px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h2>Decrypt Your Secret</h2>
  <textarea id="privateKey" placeholder="Paste your PRIVATE key here..."></textarea><br>
  <button onclick="decrypt()">Decrypt</button>

  <div id="textSecret" class="hidden">
    <h2>Your Decrypted Secret:</h2>
    <textarea id="decryptedSecret" readonly></textarea><br>
    <button onclick="copySecret()">Copy to Clipboard</button>
  </div>

  <div id="fileSecret" class="hidden">
    <h2>Your File is Ready</h2>
    <div class="filename">Filename: <strong id="fileNameBox"></strong></div>
    <button onclick="downloadDecryptedFile()">Download File</button>
  </div>

  <!-- Encrypted data embedded by server -->
  <script>
    const encrypted = "{{ secret }}";
    const isFile = {{ 'true' if is_file else 'false' }};
    const filename = "{{ filename if is_file else '' }}";
    const mimetype = "{{ mimetype if is_file else '' }}";
  </script>

  <!-- Decryption Script -->
  <script>
    async function importPrivateKey(pemKey) {
      const binaryDer = Uint8Array.from(atob(pemKey), c => c.charCodeAt(0));
      return await window.crypto.subtle.importKey(
        "pkcs8",
        binaryDer,
        {
          name: "RSA-OAEP",
          hash: "SHA-256",
        },
        false,
        ["decrypt"]
      );
    }

    async function decryptData(encryptedB64, privateKey) {
      const encryptedBytes = Uint8Array.from(atob(encryptedB64), c => c.charCodeAt(0));
      const decrypted = await window.crypto.subtle.decrypt(
        { name: "RSA-OAEP" },
        privateKey,
        encryptedBytes
      );
      return new Uint8Array(decrypted);
    }

    async function decrypt() {
      const privateKeyText = document.getElementById("privateKey").value.trim();
      if (!privateKeyText) {
        alert("Please paste your private key.");
        return;
      }

      try {
        const privateKey = await importPrivateKey(privateKeyText);
        const decryptedBytes = await decryptData(encrypted, privateKey);

        if (isFile) {
          window.decryptedFile = decryptedBytes;
          document.getElementById("fileNameBox").innerText = filename;
          document.getElementById("fileSecret").classList.remove("hidden");
        } else {
          const decoded = new TextDecoder().decode(decryptedBytes);
          document.getElementById("decryptedSecret").value = decoded;
          document.getElementById("textSecret").classList.remove("hidden");
        }
      } catch (e) {
        console.error(e);
        alert("Failed to decrypt. Make sure the private key is correct.");
      }
    }

    function copySecret() {
      const textArea = document.getElementById("decryptedSecret");
      textArea.select();
      document.execCommand("copy");
      alert("Secret copied to clipboard!");
    }

    function downloadDecryptedFile() {
      const blob = new Blob([window.decryptedFile], { type: mimetype || "application/octet-stream" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename || "secret-file";
      link.click();
    }
  </script>

</body>
</html>

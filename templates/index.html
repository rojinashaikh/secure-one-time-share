<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Secret</title>
    <style>
        /* Blue-to-Orange Gradient Background */
        body {
            background: linear-gradient(to right, #00b4d8, #f97316);
            font-family: Arial, sans-serif;
            color: #000; /* Set text color to black */
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            padding-top: 50px;
            font-size: 36px;
        }

        form {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            background-color: #fff; /* Full white background */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); /* Soft shadow */
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="password"], input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #000; /* Black text in input */
        }

        textarea {
            height: 150px;
            resize: vertical;
        }

        button {
            background-color: #0077b6;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background-color: #023e8a;
        }
    </style>
</head>
<body>
    <h1>Create a Secret</h1>
    <form id="secretForm" action="{{ url_for('create_secret') }}" method="POST" enctype="multipart/form-data">
        <div>
            <label for="secret">Text Secret (Optional):</label>
            <textarea name="secret" id="secret" placeholder="Enter your secret here..."></textarea>
        </div>

        <div>
            <label for="file">Upload a File (Optional):</label>
            <input type="file" name="file" id="file">
        </div>

        <div>
            <label for="public_key">Public Key:</label>
            <textarea name="public_key" id="public_key" placeholder="Enter Public Key" required>
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsADRa/IXFPkL8PBz25PD
YioHbqpQlEVSatPCxE62C1CjpFAJnqpxTmjng0soTvUlISHsguC8XDK35dufddaA
Fy7WSpjsbouYSnFE2om/M1EdWEDlLP2s84HXuFtY4XKVPPsKXOMdm1qiaJdmhOMa
2KFeU58R5eoQ5rTFg3JZefFOZKDvwWx6NO6BHHpz12XzL3DCUoWnNdsu6EFdxA+y
Eqhvn7YDIZUuQwiwAqTzMwU29s6xO0jqI8pW7FQJ7ZNuca4dZxmSQgPG6BukeN6f
DWui9QqOHE/CaAsKGXbDBCVxREFItOp+lV3mKaiZ1KMVRoztDEiwH+viYGv1LYjj
NQIDAQAB
-----END PUBLIC KEY-----
            </textarea>
        </div>

        <div>
            <button type="submit">Create Secret</button>
        </div>
    </form>

    <script>
        async function encryptSecret(secret, publicKey) {
            const enc = new TextEncoder();
            const data = enc.encode(secret);

            // Convert PEM to ArrayBuffer
            const pemHeader = "-----BEGIN PUBLIC KEY-----";
            const pemFooter = "-----END PUBLIC KEY-----";
            const pemContents = publicKey.substring(pemHeader.length, publicKey.length - pemFooter.length);
            const binaryDerString = window.atob(pemContents);
            const binaryDer = str2ab(binaryDerString);

            // Import the public key
            const importedPublicKey = await window.crypto.subtle.importKey(
                "spki",
                binaryDer,
                {
                    name: "RSA-OAEP",
                    hash: { name: "SHA-256" }
                },
                false,
                ["encrypt"]
            );

            // Encrypt the secret
            const encryptedData = await window.crypto.subtle.encrypt(
                {
                    name: "RSA-OAEP"
                },
                importedPublicKey,
                data
            );

            return encryptedData;
        }

        function str2ab(str) {
            const buf = new ArrayBuffer(str.length);
            const bufView = new Uint8Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        document.getElementById("secretForm").onsubmit = async function(event) {
            event.preventDefault();

            const secret = document.getElementById("secret").value;
            const file = document.getElementById("file").files[0];
            const publicKey = document.getElementById("public_key").value;

            let encryptedSecret;

            // Encrypt text secret if provided
            if (secret) {
                encryptedSecret = await encryptSecret(secret, publicKey);
            }

            // Prepare form data
            const formData = new FormData();
           ('encrypted', new Blob([encryptedSecret]));
            formData.append('secret', secret);
            formData.append('public_key', publicKey);
            if (file) {
                formData.append('file', file);
            }

            // Send the encrypted secret to the server
            fetch('{{ url_for("create_secret") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                window.location.href = data.share_url;
            })
            .catch(error => console.error('Error:', error));
        };
    </script>
</body>
</html>
